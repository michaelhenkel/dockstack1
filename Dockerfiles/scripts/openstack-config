#general
rabbitmqctl change_password guest guest

#keystone
mysql -h vip -u root -pladakh1 -e "CREATE DATABASE keystone;"
mysql -h vip -u root -pladakh1 -e "GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'vip.endor.lab' \
                                          IDENTIFIED BY 'ladakh1';"

openstack-config --set /var/lib/docker-volumes/os1/keystone/keystone.conf DEFAULT admin_token ladakh1
openstack-config --set /var/lib/docker-volumes/os1/keystone/keystone.conf DEFAULT log_dir /var/log/keystone
openstack-config --set /var/lib/docker-volumes/os1/keystone/keystone.conf DEFAULT rabbit_host vip
openstack-config --set /var/lib/docker-volumes/os1/keystone/keystone.conf database connection mysql://keystone:ladakh1@vip/keystone

docker exec -it os1 supervisorctl restart keystone

docker exec -it os1 keystone-manage --config-dir /etc/supervisor/conf.d/keystone db_sync

source /etc/supervisor/conf.d/openrc

keystone tenant-create --name admin --description "Admin Tenant"
keystone user-create --name admin --pass ladakh1 --email chief@endor.lab
keystone role-create --name admin
keystone user-role-add --user admin --tenant admin --role admin
keystone tenant-create --name service --description "Service Tenant"

keystone service-create --name keystone --type identity \
  --description "OpenStack Identity"
keystone endpoint-create \
  --service-id $(keystone service-list | awk '/ identity / {print $2}') \
  --publicurl http://vip:5000/v2.0 \
  --internalurl http://vip:5000/v2.0 \
  --adminurl http://vip:35357/v2.0 \
  --region regionOne

#glance
mysql -h vip -u root -pladakh1 -e "CREATE DATABASE glance;"
mysql -h vip -u root -pladakh1 -e "GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'vip.endor.lab' \
                                          IDENTIFIED BY 'ladakh1';"
keystone user-create --name glance --pass ladakh1
keystone user-role-add --user glance --tenant services --role admin
keystone service-create --name glance --type image \
  --description "OpenStack Image Service"
keystone endpoint-create \
  --service-id $(keystone service-list | awk '/ image / {print $2}') \
  --publicurl http://vip:9292 \
  --internalurl http://vip:9292 \
  --adminurl http://vip:9292 \
  --region regionOne

openstack-config --set /var/lib/docker-volumes/os1/glance/glance-api.conf DEFAULT rabbit_host vip
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-api.conf DEFAULT notification_driver noop
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-api.conf database connection mysql://glance:ladakh1@vip/glance
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-api.conf keystone_authtoken auth_uri http://vip:5000/v2.0
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-api.conf keystone_authtoken identity_uri http://vip:35357
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-api.conf keystone_authtoken admin_tenant_name service
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-api.conf keystone_authtoken admin_user glance
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-api.conf keystone_authtoken admin_password ladakh1
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-api.conf paste_deploy flavor keystone
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-api.conf glance_store default_store file
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/


openstack-config --set /var/lib/docker-volumes/os1/glance/glance-registry.conf DEFAULT rabbit_host vip
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-registry.conf DEFAULT notification_driver noop
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-registry.conf database connection mysql://glance:ladakh1@vip/glance
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-registry.conf keystone_authtoken auth_uri http://vip:5000/v2.0
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-registry.conf keystone_authtoken identity_uri http://vip:35357
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-registry.conf keystone_authtoken admin_tenant_name service
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-registry.conf keystone_authtoken admin_user nova
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-registry.conf keystone_authtoken admin_password ladakh1
openstack-config --set /var/lib/docker-volumes/os1/glance/glance-registry.conf paste_deploy flavor keystone

docker exec -it os1 supervisorctl restart glance-api
docker exec -it os1 supervisorctl restart glance-registry

su -s /bin/sh -c "glance-manage --config-dir /etc/supervisor/conf.d/glance db_sync" glance

#nova

mysql -h vip -u root -pladakh1 -e "CREATE DATABASE nova;"
mysql -h vip -u root -pladakh1 -e "GRANT ALL PRIVILEGES ON nova.* TO 'nova'@'vip.endor.lab' \
                                          IDENTIFIED BY 'ladakh1';"

keystone user-create --name nova --pass ladakh1
keystone user-role-add --user nova --tenant service --role admin
keystone service-create --name nova --type compute \
  --description "OpenStack Compute"
keystone endpoint-create \
  --service-id $(keystone service-list | awk '/ compute / {print $2}') \
  --publicurl http://vip:8774/v2/%\(tenant_id\)s \
  --internalurl http://vip:8774/v2/%\(tenant_id\)s \
  --adminurl http://vip:8774/v2/%\(tenant_id\)s \
  --region regionOne


openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf DEFAULT rabbit_host vip
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf DEFAULT rpc_backend rabbit
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf DEFAULT rabbit_password guest
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf DEFAULT auth_strategy keystone
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf DEFAULT my_ip os1
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf DEFAULT vncserver_listen os1
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf DEFAULT vncserver_proxyclient_address os1
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf DEFAULT verbose True
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf keystone_authtoken auth_uri http://vip:5000/v2.0
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf keystone_authtoken identity_uri http://vip:35357
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf keystone_authtoken admin_tenant_name service
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf keystone_authtoken admin_user nova
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf keystone_authtoken admin_password ladakh1
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf database connection mysql://nova:ladakh1@vip/nova
openstack-config --set /var/lib/docker-volumes/os1/nova/nova.conf glance host vip

nova-manage --config-file /etc/supervisor/conf.d/nova/nova.conf db sync
supervisorctl reload

#Neutron


mysql -h vip -u root -pladakh1 -e "CREATE DATABASE neutron;"
mysql -h vip -u root -pladakh1 -e "GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'vip.endor.lab' \
                                          IDENTIFIED BY 'ladakh1';"

keystone user-create --name neutron --pass ladakh1
keystone user-role-add --user neutron --tenant service --role admin
keystone service-create --name neutron --type network \
  --description "OpenStack Networking"
keystone endpoint-create \
  --service-id $(keystone service-list | awk '/ network / {print $2}') \
  --publicurl http://vip:9696 \
  --adminurl http://vip:9696 \
  --internalurl http://vip:9696 \
  --region regionOne

openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf database connection mysql://neutron:ladakh1@vip/neutron
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT rpc_backend rabbit
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT rabbit_host vip
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT rabbit_password guest
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT auth_strategy keystone
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf keystone_authtoken auth_uri http://vip:5000/v2.0
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf keystone_authtoken identity_uri http://vip:35357
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf keystone_authtoken admin_tenant_name service
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf keystone_authtoken admin_user neutron
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf keystone_authtoken admin_password ladakh1
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT core_plugin ml2
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT service_plugins router
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT allow_overlapping_ips True
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes True
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes True
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT nova_url http://vip:8774/v2
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT nova_admin_auth_url http://vip:35357/v2.0
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT nova_region_name regionOne
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT nova_admin_username nova
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT nova_admin_tenant_id 06943cbb7f6640879bb332e1a5285ce1
openstack-config --set /var/lib/docker-volumes/os1/neutron/neutron.conf DEFAULT nova_admin_password ladakh1

#cinder


mysql -h vip -u root -pladakh1 -e "CREATE DATABASE cinder;"
mysql -h vip -u root -pladakh1 -e "GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'vip.endor.lab' \
                                          IDENTIFIED BY 'ladakh1';"

keystone user-create --name cinder --pass ladakh1
keystone user-role-add --user cinder --tenant service --role admin
keystone service-create --name cinder --type volume \
  --description "OpenStack Block Storage"
keystone service-create --name cinderv2 --type volumev2 \
  --description "OpenStack Block Storage"
keystone endpoint-create \
  --service-id $(keystone service-list | awk '/ volume / {print $2}') \
  --publicurl http://vip:8776/v1/%\(tenant_id\)s \
  --internalurl http://vip:8776/v1/%\(tenant_id\)s \
  --adminurl http://vip:8776/v1/%\(tenant_id\)s \
  --region regionOne
keystone endpoint-create \
  --service-id $(keystone service-list | awk '/ volumev2 / {print $2}') \
  --publicurl http://vip:8776/v2/%\(tenant_id\)s \
  --internalurl http://vip:8776/v2/%\(tenant_id\)s \
  --adminurl http://vip:8776/v2/%\(tenant_id\)s \
  --region regionOne

openstack-config --set /var/lib/docker-volumes/os1/cinder/cinder.conf DEFAULT rpc_backend rabbit
openstack-config --set /var/lib/docker-volumes/os1/cinder/cinder.conf DEFAULT rabbit_host vip
openstack-config --set /var/lib/docker-volumes/os1/cinder/cinder.conf DEFAULT rabbit_password guest
openstack-config --set /var/lib/docker-volumes/os1/cinder/cinder.conf DEFAULT auth_strategy keystone
openstack-config --set /var/lib/docker-volumes/os1/cinder/cinder.conf database connection mysql://cinder:ladakh1@vip.endor.lab/cinder
openstack-config --set /var/lib/docker-volumes/os1/cinder/cinder.conf keystone_authtoken auth_uri http://vip:5000/v2.0
openstack-config --set /var/lib/docker-volumes/os1/cinder/cinder.conf keystone_authtoken identity_uri http://vip:35357
openstack-config --set /var/lib/docker-volumes/os1/cinder/cinder.conf keystone_authtoken admin_tenant_name service
openstack-config --set /var/lib/docker-volumes/os1/cinder/cinder.conf keystone_authtoken admin_user cinder
openstack-config --set /var/lib/docker-volumes/os1/cinder/cinder.conf keystone_authtoken admin_password ladakh1

ports:
rabbit: 5672
keystone: 35357, 5000
